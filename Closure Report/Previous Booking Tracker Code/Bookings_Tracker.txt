SELECT 
	CONVERT(DATE, DATEADD(HOUR, -6,SALESDATE), 112) AS SALESDATE,
	DATEADD(HOUR, -6,SALESDATE) AS SALESDATETIME,
	DATEPART(HOUR,DATEADD(HOUR, -6,SALESDATE)) AS SALESHOUR,
	EOMONTH(CONVERT(DATE, DATEADD(HOUR, -6,SALESDATE), 112)) AS SALESMONTH,
	A.DEPARTUREDATE,
	D.STD AS DEPARTUREDATETIME,
	D.STDUTC AS DEPARTUREDATETIME_UTC,
	DATEPART(HOUR,D.STD) AS DEPARTUREHOUR,
	EOMONTH(A.DEPARTUREDATE) AS DEPARTUREMONTH,
	CASE WHEN DATEPART(DW,A.DEPARTUREDATE) = 1 THEN 7 ELSE DATEPART(DW,A.DEPARTUREDATE)-1 END AS DEPARTUREDOW,
	CAST(D.STA AS DATE) AS ARRIVALDATE,
	D.STA AS ARRIVALDATETIME,
	DATEPART(HOUR,D.STA) AS ARRIVALHOUR,
	CASE WHEN D.DEPARTURESTATION<D.ARRIVALSTATION THEN D.DEPARTURESTATION+D.ARRIVALSTATION ELSE D.ARRIVALSTATION+D.DEPARTURESTATION END AS ALPHAMKT,
	D.DEPARTURESTATION+D.ARRIVALSTATION AS DIRMKT,
	D.FLIGHTNUMBER,
	F.RECORDLOCATOR,
	A.CLASSOFSERVICE,
	F.BOOKINGPROMOCODE,
	CASE WHEN F.SYSTEMCODE = '' THEN 'INTERNAL' ELSE F.SYSTEMCODE END AS BOOKINGSOURCE,
	F.SOURCEORGANIZATIONCODE,
	A.INTERNATIONAL AS INTERNATIONAL_FLAG,
	(CASE WHEN RIGHT(A.FAREBASIS,3) IN ('V5N','VDN','E5P','EDC') OR F.SYSTEMCODE = 'Y4' THEN 1 ELSE 0 END) AS CODESHARE_FLAG,
	CASE WHEN D.FLIGHTNUMBER BETWEEN 1 AND 2999 THEN 'F9 SCHEDULED'
		WHEN D.FLIGHTNUMBER BETWEEN 6000 AND 6999 THEN 'Y4 OPERATED'
		WHEN D.FLIGHTNUMBER BETWEEN 7000 AND 7999 THEN 'F9 EXTRA SECTION'
		WHEN D.FLIGHTNUMBER BETWEEN 8000 AND 8999 THEN 'F9 CHARTER'
		WHEN D.FLIGHTNUMBER BETWEEN 9000 AND 9999 THEN 'F9 FERRY'
		ELSE 'UNCATEGORIZED' END AS FLIGHT_TYPE,
	A.FAREBASIS,
	D.EQUIPMENTTYPE,
	C.UNITDESIGNATOR AS SEATNUMBER,
	COUNT(DISTINCT F.[RECORDLOCATOR]) AS PNRS,
	COUNT(DISTINCT C.PASSENGERID + '-' + C.SEGMENTID + '-' +  C.LEGNUMBER + '-' +  C.JOURNEYNUMBER) AS LEGS,
	COUNT(DISTINCT C.PASSENGERID + '-' + C.SEGMENTID + '-' +  C.JOURNEYNUMBER) AS JOURNEYS,
	SUM(CASE WHEN B.CHARGETYPE IN (0,19) AND C.LEGNUMBER = 1 THEN [CHARGEAMOUNT] END) - SUM(CASE WHEN B.CHARGETYPE IN (1,2,7) AND C.LEGNUMBER = 1 THEN [CHARGEAMOUNT] ELSE 0 END) AS TICKETREV,
	SUM(CASE WHEN B.CHARGETYPE = 7 THEN CHARGEAMOUNT ELSE 0 END) AS PROMODISCOUNTREV,
		E.PAXTYPE,
		G.CONNECT_INDICATOR,
		G.ROUNDTRIP_INDICATOR,
	CASE
		WHEN F.SystemCode = '' and F.sourceorganizationcode = 'F9' THEN 'Internal'
		WHEN F.SystemCode = '' and F.sourceorganizationcode = 'System' THEN 'Internal'
		WHEN F.SystemCode = '' and F.sourceorganizationcode not in ('F9','System') THEN 'Other'
		ELSE F.systemcode END AS GDS
      

FROM [REZF9OD01].[DBO].[PASSENGERJOURNEYSEGMENT] A
	JOIN [REZF9OD01].[DBO].[PASSENGERJOURNEYCHARGE] B ON A.PASSENGERID = B.PASSENGERID AND A.SEGMENTID = B.SEGMENTID
	JOIN [REZF9OD01].[DBO].[PASSENGERJOURNEYLEG] C ON A.PASSENGERID = C.PASSENGERID AND A.SEGMENTID = C.SEGMENTID 
	JOIN [REZF9OD01].[DBO].[INVENTORYLEG] D ON C.[INVENTORYLEGID] = D.[INVENTORYLEGID]
	JOIN [REZF9OD01].[DBO].[BOOKINGPASSENGER] E ON A.PASSENGERID = E.PASSENGERID
	JOIN [REZF9OD01].[DBO].[BOOKING] F ON E.BOOKINGID = F.BOOKINGID
	JOIN (
		SELECT
			F.RECORDLOCATOR,
			MAX(C.JourneyNumber) 'Max Journey',
			CASE WHEN (COUNT(DISTINCT D.InventoryLegID)/MAX(C.JourneyNumber)) > 1 THEN 'Connection' ELSE 'Local' END  'CONNECT_INDICATOR',
			CASE WHEN MAX(C.JourneyNumber) > 1 THEN 'Round-Trip' ELSE 'One-Way' END 'ROUNDTRIP_INDICATOR'

		FROM [REZF9OD01].[DBO].[PASSENGERJOURNEYSEGMENT] A (NOLOCK)
			JOIN [REZF9OD01].[DBO].[PASSENGERJOURNEYCHARGE] B (NOLOCK) ON A.PASSENGERID = B.PASSENGERID AND A.SEGMENTID = B.SEGMENTID
			JOIN [REZF9OD01].[DBO].[PASSENGERJOURNEYLEG] C (NOLOCK) ON A.PASSENGERID = C.PASSENGERID AND A.SEGMENTID = C.SEGMENTID 
			JOIN [REZF9OD01].[DBO].[INVENTORYLEG] D (NOLOCK) ON C.[INVENTORYLEGID] = D.[INVENTORYLEGID]
			JOIN [REZF9OD01].[DBO].[BOOKINGPASSENGER] E (NOLOCK) ON A.PASSENGERID = E.PASSENGERID
			JOIN [REZF9OD01].[DBO].[BOOKING] F (NOLOCK) ON E.BOOKINGID = F.BOOKINGID
  
		WHERE 
			A.BOOKINGSTATUS = 'HK'
			AND CONVERT(DATE, DATEADD(HOUR, -6,SALESDATE), 112) >= CAST(DATEADD(HOUR, -6, GETDATE()) AS DATE)

		GROUP BY
			CONVERT(DATE, DATEADD(HOUR, -6,SALESDATE), 112),
			F.RECORDLOCATOR) G ON F.RecordLocator = G.RecordLocator
  
WHERE 
	A.BOOKINGSTATUS = 'HK'
	AND CONVERT(DATE, DATEADD(HOUR, -6,SALESDATE), 112) >= CAST(DATEADD(HOUR, -6, GETDATE()) AS DATE)

GROUP BY 
	CONVERT(DATE, DATEADD(HOUR, -6,SALESDATE), 112),
	DATEADD(HOUR, -6,SALESDATE),
	A.DEPARTUREDATE,
	D.STD,
	D.STDUTC,
	EOMONTH(A.DEPARTUREDATE),
	DATEPART(DW,A.DEPARTUREDATE),
	CAST(D.STA AS DATE),
	D.STA,
	CASE WHEN D.DEPARTURESTATION<D.ARRIVALSTATION THEN D.DEPARTURESTATION+D.ARRIVALSTATION ELSE D.ARRIVALSTATION+D.DEPARTURESTATION END,
	D.DEPARTURESTATION+D.ARRIVALSTATION,
	D.FLIGHTNUMBER,
	F.RECORDLOCATOR,
	A.CLASSOFSERVICE,
	F.BOOKINGPROMOCODE,
	CASE WHEN F.SYSTEMCODE = '' THEN 'INTERNAL' ELSE F.SYSTEMCODE END,
	F.SOURCEORGANIZATIONCODE,
	A.INTERNATIONAL,
	CASE WHEN RIGHT(A.FAREBASIS,3) IN ('V5N','VDN','E5P','EDC') OR F.SYSTEMCODE = 'Y4' THEN 1 ELSE 0 END,
	CASE WHEN D.FLIGHTNUMBER BETWEEN 1 AND 2999 THEN 'F9 SCHEDULED'
		WHEN D.FLIGHTNUMBER BETWEEN 6000 AND 6999 THEN 'Y4 OPERATED'
		WHEN D.FLIGHTNUMBER BETWEEN 7000 AND 7999 THEN 'F9 EXTRA SECTION'
		WHEN D.FLIGHTNUMBER BETWEEN 8000 AND 8999 THEN 'F9 CHARTER'
		WHEN D.FLIGHTNUMBER BETWEEN 9000 AND 9999 THEN 'F9 FERRY'
		ELSE 'UNCATEGORIZED' END,
	A.FAREBASIS,
	D.EQUIPMENTTYPE,
	C.UNITDESIGNATOR,
	E.PAXTYPE,
	G.CONNECT_INDICATOR,
	G.ROUNDTRIP_INDICATOR,
	CASE
		WHEN F.SystemCode = '' and F.sourceorganizationcode = 'F9' THEN 'Internal'
		WHEN F.SystemCode = '' and F.sourceorganizationcode = 'System' THEN 'Internal'
		WHEN F.SystemCode = '' and F.sourceorganizationcode not in ('F9','System') THEN 'Other'
		ELSE F.systemcode END

ORDER BY
	F.RECORDLOCATOR